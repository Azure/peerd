apiVersion: v1
kind: Namespace
metadata:
  name: peerd-ns
---
kind: ConfigMap
apiVersion: v1
data:
  prometheus-config: |-
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: peerd
      static_configs:
      - targets:
        - peerd.peerd-ns.svc.cluster.local:5004
      metrics_path: /metrics/prometheus
metadata:
  name: ama-metrics-prometheus-config
  namespace: kube-system
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: &name peerd
  namespace: peerd-ns
  labels:
    app: *name
  annotations:
    prometheus.io/scrape: 'true'
    prometheus.io/path: '/metrics/prometheus'
    prometheus.io/port: '5004'
spec:
  selector:
    matchLabels:
      app: *name
  template:
    metadata:
      labels:
        app: *name
    spec:
      serviceAccountName: peerd-sa
      containers:
        - image: "{{ .Values.peerd.image.ref }}"
          imagePullPolicy: "{{ .Values.peerd.image.pullPolicy }}"
          args:
            - "--log-level=debug"
            - "run"
            - "--http-addr=0.0.0.0:5000"
            - "--add-mirror-configuration={{ .Values.peerd.configureMirrors }}"
            {{- with .Values.peerd.hosts }}
            - --hosts
            {{- range . }}
            - {{ . | quote }}
            {{- end }}
            {{- end }}
  
          name: *name
          ports:
            - containerPort: 5000
              name: http
            - containerPort: 5001
              name: https
            - containerPort: 5003
              name: router
            - containerPort: 5004
              name: metrics
          volumeMounts:
            - name: metricsmount
              mountPath: "/var/log/peerdmetrics"
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
            - name: containerd-certs
              mountPath: /etc/containerd/certs.d
      volumes:
        - name: metricsmount
          hostPath:
            path: /var/log/peerdmetrics
            type: FileOrCreate
        - name: containerd-socket
          hostPath:
            path: /run/containerd/containerd.sock
            type: Socket
        - name: containerd-certs
          hostPath:
            path: /etc/containerd/certs.d
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: &name peerd
  namespace: peerd-ns
  labels:
    app: *name
  annotations:
    prometheus.io/scrape: 'true'
    prometheus.io/path: '/metrics/prometheus'
    prometheus.io/port: '30004'
spec:
  type: NodePort
  selector:
    app: *name
  ports:
    - name: http
      protocol: TCP
      port: 5000
      nodePort: 30000
      targetPort: http
    - name: https
      protocol: TCP
      port: 5001
      nodePort: 30001
      targetPort: https
    - name: metrics
      protocol: TCP
      port: 5004
      nodePort: 30004
      targetPort: metrics
